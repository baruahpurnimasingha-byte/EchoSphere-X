<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EchoSphere X â€” Working Hybrid Prototype</title>
<style>
:root{
  --bg-dark:#04050a; --bg-light:#f6f8fb; --neon:#001428;
  --accentA: #00d9ff; --accentB: #ff6bb0;
  --glass: rgba(255,255,255,0.04);
  --muted: rgba(255,255,255,0.75);
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg-dark);color:#eaf7ff;-webkit-font-smoothing:antialiased;overflow:hidden}

/* Generic */
.app-page{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;transition:opacity .36s,transform .36s;opacity:0;pointer-events:none}
.app-page.active{opacity:1;pointer-events:all}
.card{width:92%;max-width:920px;padding:18px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 20px 60px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
.center{display:flex;flex-direction:column;align-items:center;gap:12px;text-align:center}

/* Orb / splash */
.orbWrap{width:320px;height:320px;border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative}
#orbCanvas{width:100%;height:100%;border-radius:50%;cursor:pointer;display:block}
.orbLabel{position:absolute;bottom:18px;padding:8px 12px;border-radius:12px;font-weight:800;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#001}

/* Login */
.login-grid{display:flex;flex-direction:column;gap:10px}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.35);color:#fff;outline:none}
.btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accentA),var(--accentB));color:#001;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}

/* App layout */
.app-shell{position:relative;width:100%;height:100%;display:flex;flex-direction:column}
.app-header{position:fixed;left:18px;right:18px;top:12px;height:56px;display:flex;align-items:center;gap:12px;z-index:60}
.app-title{font-weight:800}
.top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.theme-select{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit}

/* main grid */
.main-grid{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:100px 20px 20px 20px;height:100%;box-sizing:border-box}
.left-col{overflow:auto;padding-right:8px}
.right-col{position:relative}

/* glass card */
.glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}

/* chat */
.chat-box{height:320px;border-radius:12px;padding:12px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column}
.messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px}
.bubble{padding:10px;border-radius:10px;max-width:86%}
.me{align-self:flex-end;background:linear-gradient(90deg, rgba(0,191,255,0.08), rgba(0,191,255,0.04))}
.ai{align-self:flex-start;background:linear-gradient(90deg, rgba(255,105,180,0.06), rgba(255,105,180,0.03))}

/* radial deck */
.corner-deck{position:fixed;right:16px;bottom:16px;z-index:80;display:flex;flex-direction:column;align-items:flex-end;gap:10px}
.deck-toggle{width:64px;height:64px;border-radius:50%;background:linear-gradient(90deg,var(--accentA),var(--accentB));display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer;box-shadow:0 12px 40px rgba(0,183,255,0.12)}
.radial{position:fixed;right:96px;bottom:96px;width:240px;height:240px;border-radius:50%;pointer-events:none;z-index:79}
.radial .item{position:absolute;width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(10,12,20,0.9);border:1px solid rgba(255,255,255,0.03);color:inherit;cursor:pointer;pointer-events:auto;opacity:0;transform:scale(.8);transition:all .28s}

/* small responsive */
@media(max-width:980px){.main-grid{grid-template-columns:1fr;}.radial{display:none}}
.small{font-size:13px;color:var(--muted)}
.muted{color:var(--muted)}
</style>
</head>
<body>

<!-- SPLASH -->
<section id="splash" class="app-page active">
  <div class="card center">
    <h1>EchoSphere X</h1>
    <p class="small muted">A universe where imagination begins â€” tap the orb to enter</p>
    <div style="margin-top:14px" class="orbWrap">
      <canvas id="orbCanvas" width="320" height="320" title="Tap to enter"></canvas>
      <div class="orbLabel">Enter EchoSphere X</div>
    </div>
    <p class="small" style="max-width:640px;margin-top:10px">Hybrid AI + Idea Garden + Floating Radial Deck. Works offline and can connect to a local proxy at <code>http://localhost:3000/api/chat</code> when available.</p>
  </div>
</section>

<!-- LOGIN -->
<section id="login" class="app-page">
  <div class="card login-grid" style="max-width:520px">
    <h2>Login</h2>
    <p class="small muted">Name & Email required</p>
    <input id="nameField" class="input" placeholder="Full name" />
    <input id="emailField" class="input" placeholder="Email address" />
    <input id="passField" class="input" placeholder="Password (demo)" type="password" />
    <div style="display:flex;gap:10px">
      <button id="loginBtn" class="btn">Continue</button>
      <button id="cancelLogin" class="btn ghost">Back</button>
    </div>
  </div>
</section>

<!-- INTRO -->
<section id="intro" class="app-page">
  <div class="card center" style="max-width:880px">
    <h2>Welcome to EchoSphere X</h2>
    <p class="small muted" style="max-width:720px">An adaptive AI-powered idea companion â€” think, create, connect, and solve.</p>
    <div style="margin-top:14px;text-align:left;max-width:640px">
      <strong>Prototype includes:</strong>
      <ul>
        <li>Hybrid AI (local proxy â†’ offline fallback)</li>
        <li>Idea Garden, AI Chat, Personality Modes, Idea Vault</li>
        <li>Orb color controls, Theme switcher, Radial deck</li>
      </ul>
    </div>
    <div style="margin-top:12px">
      <button id="enterApp" class="btn">Enter App</button>
      <button id="skipIntro" class="btn ghost">Skip</button>
    </div>
  </div>
</section>

<!-- APP -->
<section id="app" class="app-page">
  <div class="app-shell" style="width:100%;height:100%">
    <div class="app-header">
      <div class="app-title">EchoSphere X â€” <span id="userGreeting">Welcome</span></div>
      <div class="top-actions">
        <select id="themeSel" class="theme-select" title="Theme">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="neon">Neon</option>
        </select>
        <button id="profileBtn" class="btn ghost small">Profile</button>
      </div>
    </div>

    <div class="main-grid">
      <div class="left-col">
        <div class="glass">
          <h3>Dashboard</h3>
          <p class="small muted">Welcome back â€” <strong id="userNameDisplay"></strong></p>
          <div style="display:flex;gap:10px;margin-top:12px">
            <button id="openIdea" class="btn small">Idea Garden</button>
            <button id="openChat" class="btn small">AI Chat</button>
            <button id="openProfile" class="btn ghost small">Profile</button>
          </div>
          <div style="margin-top:12px" class="small">Ideas saved: <strong id="ideaCount">0</strong> â€¢ Chat messages: <strong id="chatCount">0</strong></div>
        </div>

        <div class="glass" style="margin-top:12px">
          <h4>Idea Garden</h4>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="seedInput" class="input" placeholder="Type a seed idea..." />
            <button id="growBtn" class="btn small">Grow</button>
          </div>
          <div id="ideaList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px"></div>
        </div>

        <div class="glass" style="margin-top:12px">
          <h4>Personality Modes</h4>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn ghost pmode" data-mode="Creator">Creator</button>
            <button class="btn ghost pmode" data-mode="Analyst">Analyst</button>
            <button class="btn ghost pmode" data-mode="Mentor">Mentor</button>
            <button class="btn ghost pmode" data-mode="Simple">Simple</button>
            <button class="btn ghost pmode" data-mode="Hyper">Hyper</button>
          </div>
          <p class="small" style="margin-top:8px">Selected: <strong id="modeSelected">Creator</strong></p>
        </div>
      </div>

      <div class="right-col">
        <div class="chat-box glass">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>AI Chat â€” Echo Companion</strong></div>
            <div class="small">Mode: <span id="chatModeDisplay">Creator</span></div>
          </div>
          <div class="messages" id="messages"></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="chatInput" class="input" placeholder="Ask EchoSphere..." />
            <button id="voiceBtn" class="btn ghost">ðŸŽ¤</button>
            <button id="sendBtn" class="btn">Send</button>
          </div>
          <div class="small muted" style="margin-top:8px">Double-click an AI reply to save it to the Idea Vault.</div>
        </div>

        <div class="glass" style="margin-top:12px">
          <h4>Idea Vault</h4>
          <div id="vaultList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- radial deck -->
    <div class="corner-deck">
      <div class="radial" id="radial"></div>
      <div class="deck-toggle" id="deckToggle">â‰¡</div>
    </div>

    <!-- small settings panel -->
    <div id="settingsPanel" style="position:fixed;left:50%;top:70px;transform:translateX(-50%);width:420px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:none;z-index:90">
      <h4 style="margin:0 0 8px 0">Settings & Orb Colors</h4>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="width:110px">Primary</label>
        <input id="orbPrimary" type="color" />
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label style="width:110px">Secondary</label>
        <input id="orbSecondary" type="color" />
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="saveOrbColors" class="btn small">Save</button>
        <button id="closeSettings" class="btn small ghost">Close</button>
      </div>
    </div>

  </div>
</section>

<!-- PROFILE PAGE (modal-like) -->
<section id="profile" class="app-page">
  <div class="card" style="max-width:720px">
    <h3>Profile</h3>
    <p id="profileName">Name: â€”</p>
    <p>Ideas saved: <span id="profileIdeas">0</span></p>
    <p>Chats: <span id="profileChats">0</span></p>
    <div style="margin-top:12px"><button id="profileClose" class="btn ghost">Back</button></div>
  </div>
</section>

<!-- VAULT PAGE -->
<section id="vault" class="app-page">
  <div class="card" style="max-width:920px">
    <h3>Idea Vault</h3>
    <div id="vaultFull" style="margin-top:12px;display:flex;flex-direction:column;gap:10px"></div>
    <div style="margin-top:12px"><button id="vaultClose" class="btn ghost">Back</button></div>
  </div>
</section>

<!-- IDEAGARDEN PAGE -->
<section id="ideagarden" class="app-page">
  <div class="card" style="max-width:920px">
    <h3>Idea Garden</h3>
    <p class="small muted">Seed an idea, grow branches, save to vault.</p>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="gardenSeed" class="input" placeholder="Seed idea..." />
      <button id="gardenGrow" class="btn">Grow</button>
    </div>
    <div id="gardenList" style="margin-top:12px;display:flex;flex-direction:column;gap:8px"></div>
    <div style="margin-top:12px"><button id="gardenClose" class="btn ghost">Back</button></div>
  </div>
</section>

<!-- AI FULL PAGE -->
<section id="aifull" class="app-page">
  <div class="card" style="max-width:920px">
    <h3>EchoSphere AI â€” Full Chat</h3>
    <div id="aiMessages" style="height:360px;overflow:auto;background:rgba(0,0,0,0.35);padding:12px;border-radius:10px"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="aiInput" class="input" placeholder="Ask EchoSphere..." />
      <button id="aiSend" class="btn">Send</button>
    </div>
    <div style="margin-top:10px"><button id="aiClose" class="btn ghost">Back</button></div>
  </div>
</section>

<script>
/* ---------- Lightweight SPA helpers ---------- */
const pages = {
  splash: document.getElementById('splash'),
  login: document.getElementById('login'),
  intro: document.getElementById('intro'),
  app: document.getElementById('app'),
  profile: document.getElementById('profile'),
  vault: document.getElementById('vault'),
  ideagarden: document.getElementById('ideagarden'),
  aifull: document.getElementById('aifull')
};
function show(name){
  Object.values(pages).forEach(p => p.classList.remove('active'));
  const p = pages[name];
  if(p) p.classList.add('active');
  // hooks
  if(name==='app') loadVaultShort();
  if(name==='profile') fillProfile();
  if(name==='vault') renderVaultFull();
  if(name==='ideagarden') renderGarden();
  if(name==='aifull') {/* nothing */}
}
show('splash');

/* ---------- Orb: simple canvas shader-like effect (no external libs) ---------- */
const orbCanvas = document.getElementById('orbCanvas');
const ctx = orbCanvas.getContext('2d');
let orbPrimary = localStorage.getItem('es_orb_a') || '#00d9ff';
let orbSecondary = localStorage.getItem('es_orb_b') || '#ff6bb0';
function drawOrb(t){
  const w = orbCanvas.width, h = orbCanvas.height;
  ctx.clearRect(0,0,w,h);
  // radial gradient base
  const grad = ctx.createRadialGradient(w*0.35,h*0.35,w*0.1,w*0.5,h*0.5,w*0.9);
  grad.addColorStop(0, orbPrimary);
  grad.addColorStop(1, orbSecondary);
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.arc(w/2,h/2,Math.min(w,h)/2 - 2, 0, Math.PI*2); ctx.fill();
  // subtle animated veins
  ctx.globalAlpha = 0.08;
  for(let i=0;i<20;i++){
    ctx.beginPath();
    ctx.moveTo(w/2, h/2);
    const angle = (i/20)*Math.PI*2 + Math.sin(t/600 + i)*0.2;
    ctx.lineTo(w/2 + Math.cos(angle)*(w*0.45), h/2 + Math.sin(angle)*(h*0.45));
    ctx.strokeStyle = orbSecondary;
    ctx.lineWidth = 2; ctx.stroke();
  }
  ctx.globalAlpha = 1.0;
  requestAnimationFrame(drawOrb);
}
orbCanvas.width = orbCanvas.clientWidth; orbCanvas.height = orbCanvas.clientHeight;
requestAnimationFrame(drawOrb);

/* clicking orb => login */
orbCanvas.addEventListener('click', ()=> {
  // small zoom effect
  orbCanvas.style.transition = 'transform .5s, opacity .5s';
  orbCanvas.style.transform = 'scale(4)';
  orbCanvas.style.opacity = '0';
  setTimeout(()=> {
    orbCanvas.style.transform = '';
    orbCanvas.style.opacity = '';
    show('login');
  }, 520);
});

/* ---------- Login flow ---------- */
document.getElementById('cancelLogin').addEventListener('click', ()=> show('splash'));
document.getElementById('loginBtn').addEventListener('click', ()=> {
  const name = document.getElementById('nameField').value.trim();
  const email = document.getElementById('emailField').value.trim();
  if(!name || !email){ alert('Please fill Name and Email'); return; }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert('Enter a valid email'); return; }
  localStorage.setItem('es_user', name);
  localStorage.setItem('es_user_email', email);
  document.getElementById('userNameDisplay').innerText = name;
  document.getElementById('userGreeting').innerText = `Welcome, ${name.split(' ')[0] || name}`;
  show('intro');
});

/* intro enter */
document.getElementById('enterApp').addEventListener('click', ()=> show('app'));
document.getElementById('skipIntro').addEventListener('click', ()=> show('app'));

/* ---------- Radial deck ---------- */
const deckToggle = document.getElementById('deckToggle'), radial = document.getElementById('radial');
const deckItems = [
  {label:'Home', fn:()=> show('app')},
  {label:'Idea', fn:()=> show('ideagarden')},
  {label:'Chat', fn:()=> show('aifull')},
  {label:'Vault', fn:()=> show('vault')},
  {label:'Profile', fn:()=> show('profile')},
  {label:'Settings', fn:()=> openSettings()},
  {label:'Themes', fn:()=> show('intro')}
];
function buildRadial(){
  radial.innerHTML = '';
  const cx = 120, cy = 120, r = 80;
  deckItems.forEach((it,i)=>{
    const angle = (i/deckItems.length)*Math.PI*2 - Math.PI/2;
    const x = cx + r*Math.cos(angle) - 32;
    const y = cy + r*Math.sin(angle) - 32;
    const el = document.createElement('div');
    el.className = 'item';
    el.style.left = x+'px';
    el.style.top = y+'px';
    el.style.opacity = '0';
    el.style.transform = 'scale(.8)';
    el.innerText = it.label;
    el.addEventListener('click', ()=> { toggleDeck(false); setTimeout(()=> it.fn(), 220); });
    radial.appendChild(el);
  });
}
buildRadial();
let deckOpen = false;
function toggleDeck(open){
  deckOpen = (typeof open === 'boolean') ? open : !deckOpen;
  const items = radial.querySelectorAll('.item');
  if(deckOpen){
    items.forEach((el,i)=> { setTimeout(()=> { el.style.opacity='1'; el.style.transform='scale(1)'; }, i*40); });
    radial.style.pointerEvents = 'auto';
    deckToggle.innerText = 'Ã—';
  } else {
    items.forEach((el,i)=> { setTimeout(()=> { el.style.opacity='0'; el.style.transform='scale(.8)'; }, i*18); });
    radial.style.pointerEvents = 'none';
    deckToggle.innerText = 'â‰¡';
  }
}
deckToggle.addEventListener('click', ()=> toggleDeck());

/* ---------- Theme selector ---------- */
document.getElementById('themeSel').addEventListener('change', (e)=> applyTheme(e.target.value));
function applyTheme(t){
  if(t==='dark'){ document.documentElement.style.setProperty('--bg-dark','#04050a'); document.body.style.background='#04050a'; }
  else if(t==='light'){ document.body.style.background='#f6f8fb'; document.body.style.color='#111' }
  else if(t==='neon'){ document.body.style.background='#001428'; document.body.style.color='#bff' }
}

/* ---------- Orb color settings ---------- */
const orbPrimaryInput = document.getElementById('orbPrimary'), orbSecondaryInput = document.getElementById('orbSecondary');
const saveOrbBtn = document.getElementById('saveOrbColors'), closeSettingsBtn = document.getElementById('closeSettings');
function openSettings(){
  document.getElementById('settingsPanel').style.display = 'block';
  orbPrimaryInput.value = localStorage.getItem('es_orb_a') || orbPrimary;
  orbSecondaryInput.value = localStorage.getItem('es_orb_b') || orbSecondary;
}
function closeSettings(){ document.getElementById('settingsPanel').style.display = 'none'; }
saveOrbBtn.addEventListener('click', ()=>{
  const a = orbPrimaryInput.value || '#00d9ff';
  const b = orbSecondaryInput.value || '#ff6bb0';
  localStorage.setItem('es_orb_a', a); localStorage.setItem('es_orb_b', b);
  orbPrimary = a; orbSecondary = b;
  alert('Orb colors saved (applied).');
  closeSettings();
});
closeSettingsBtn.addEventListener('click', closeSettings);

/* apply color across tabs */
window.addEventListener('storage', (e)=> {
  if(e.key==='es_orb_a' || e.key==='es_orb_b'){
    orbPrimary = localStorage.getItem('es_orb_a') || orbPrimary;
    orbSecondary = localStorage.getItem('es_orb_b') || orbSecondary;
  }
});

/* ---------- Idea Garden & Vault ---------- */
const ideaList = document.getElementById('ideaList'), vaultList = document.getElementById('vaultList');
const growBtn = document.getElementById('growBtn');
growBtn.addEventListener('click', ()=> {
  const s = document.getElementById('seedInput').value.trim(); if(!s) return alert('Enter a seed');
  const idea = {title: s, desc: `Expansion for "${s}" (offline mock)`, time:Date.now()};
  const el = document.createElement('div'); el.className='glass'; el.style.padding='10px'; el.innerHTML = `<strong>${idea.title}</strong><p style="opacity:.9">${idea.desc}</p>`;
  ideaList.prepend(el);
  saveToVault(idea);
  document.getElementById('seedInput').value='';
  updateStats('idea',1);
});
function saveToVault(it){
  const arr = JSON.parse(localStorage.getItem('es_vault')||'[]'); arr.unshift(it); localStorage.setItem('es_vault', JSON.stringify(arr));
  loadVaultShort(); renderVaultFull();
}
function loadVaultShort(){
  const arr = JSON.parse(localStorage.getItem('es_vault')||'[]'); vaultList.innerHTML = ''; arr.slice(0,3).forEach(it=> { const el = document.createElement('div'); el.className='glass'; el.style.padding='8px'; el.innerText = it.title; vaultList.appendChild(el); });
}
function renderVaultFull(){
  const arr = JSON.parse(localStorage.getItem('es_vault')||'[]');
  const full = document.getElementById('vaultFull'); if(!full) return; full.innerHTML = '';
  arr.forEach(it=> { const el = document.createElement('div'); el.className='glass'; el.style.padding='10px'; el.innerHTML = `<strong>${it.title}</strong><div style="font-size:12px;color:var(--muted)">${new Date(it.time).toLocaleString()}</div><p style="opacity:.9">${it.desc}</p>`; full.appendChild(el); });
}
function updateStats(kind,amount){
  const st = JSON.parse(localStorage.getItem('es_stats')||'{}'); if(kind==='idea') st.ideaCount=(st.ideaCount||0)+amount; if(kind==='chat') st.chatCount=(st.chatCount||0)+amount; localStorage.setItem('es_stats', JSON.stringify(st));
  document.getElementById('ideaCount').innerText = st.ideaCount||0; document.getElementById('chatCount').innerText = st.chatCount||0;
}
loadVaultShort();

/* ---------- Garden full page ---------- */
document.getElementById('gardenGrow').addEventListener('click', ()=> {
  const s = document.getElementById('gardenSeed').value.trim(); if(!s) return alert('Enter seed');
  const idea = {title:s, desc:`Full expansion for ${s}`, time:Date.now()};
  const el = document.createElement('div'); el.className='glass'; el.style.padding='10px'; el.innerHTML=`<strong>${idea.title}</strong><p>${idea.desc}</p>`;
  document.getElementById('gardenList').prepend(el);
  saveToVault(idea);
  document.getElementById('gardenSeed').value='';
});

/* nav buttons */
document.getElementById('openIdea').addEventListener('click', ()=> show('ideagarden'));
document.getElementById('openChat').addEventListener('click', ()=> show('aifull'));
document.getElementById('openProfile').addEventListener('click', ()=> show('profile'));

document.getElementById('profileClose').addEventListener('click', ()=> show('app'));
document.getElementById('vaultClose').addEventListener('click', ()=> show('app'));
document.getElementById('gardenClose').addEventListener('click', ()=> show('app'));
document.getElementById('aiClose').addEventListener('click', ()=> show('app'));

/* ---------- Hybrid AI (online proxy fallback to offline) ---------- */
const sendBtn = document.getElementById('sendBtn'), chatInput = document.getElementById('chatInput'), messages = document.getElementById('messages');
const aiSendBtn = document.getElementById('aiSend'), aiInput = document.getElementById('aiInput'), aiMessages = document.getElementById('aiMessages');

sendBtn.addEventListener('click', userSend);
chatInput.addEventListener('keydown',(e)=> { if(e.key==='Enter') userSend(); });

async function userSend(){
  const txt = chatInput.value.trim(); if(!txt) return;
  appendMsg('You', txt, 'me'); chatInput.value='';
  updateStats('chat',1); window._orbState && window._orbState('listening');
  try {
    const reply = await askOnline(txt);
    appendMsg('EchoSphere', reply, 'ai');
  } catch(e){
    const reply = offlineReply(txt);
    appendMsg('EchoSphere', reply, 'ai');
  }
  window._orbState && window._orbState('responding'); attachDoubleClickSave();
}

function appendMsg(who,text,cls){
  const b = document.createElement('div'); b.className='bubble '+(cls==='me'?'me':'ai'); b.style.padding='8px'; b.innerHTML = `<strong style="display:block;color:var(--accentA)">${who}</strong><div style="margin-top:6px">${escapeHtml(text)}</div>`; messages.appendChild(b); messages.scrollTop = messages.scrollHeight;
}

function escapeHtml(s){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

async function askOnline(msg){
  const url = 'http://localhost:3000/api/chat';
  const res = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
  if(!res.ok) throw new Error('offline');
  const j = await res.json();
  return j.reply || j.choices?.[0]?.message?.content || JSON.stringify(j);
}
function offlineReply(m){
  const mm = m.toLowerCase();
  if(mm.startsWith('/reverse')) return m.replace('/reverse','').split('').reverse().join('');
  if(mm.startsWith('/synonyms')){ const k = mm.replace('/synonyms','').trim(); return `Synonyms (offline) for "${k}": ${k}-alt1, ${k}-alt2.`; }
  if(/^(how|what|why|when|where)\b/.test(mm)) return `Step-by-step: 1) Define 2) Prototype 3) Test. (Mode: ${window.EchoState?.mode||'Creator'})`;
  return `Offline idea expansion: key features and a 3-step MVP for "${m}".`;
}

function attachDoubleClickSave(){
  document.querySelectorAll('.bubble.ai').forEach(b=>{
    if(!b.dataset.bound){ b.dataset.bound='1'; b.addEventListener('dblclick', ()=>{ const txt = b.querySelector('div').innerText; saveToVault({title: txt.slice(0,60), desc: txt, time:Date.now()}); alert('Saved to Idea Vault'); }); }
  });
}

/* AI Full page send */
aiSendBtn.addEventListener('click', async ()=>{
  const t = aiInput.value.trim(); if(!t) return; appendAI('You', t); aiInput.value='';
  try { const r = await askOnline(t); appendAI('EchoSphere', r); } catch(e){ appendAI('EchoSphere', offlineReply(t)); }
});
function appendAI(who,txt){ const el = document.createElement('div'); el.style.padding='8px'; el.style.margin='6px 0'; el.style.background = who==='You' ? 'linear-gradient(90deg, rgba(0,191,255,0.06), rgba(0,191,255,0.02))' : 'linear-gradient(90deg, rgba(255,105,180,0.04), rgba(255,105,180,0.02))'; el.innerHTML = `<strong>${who}:</strong><div style="margin-top:6px">${escapeHtml(txt)}</div>`; aiMessages.appendChild(el); aiMessages.scrollTop = aiMessages.scrollHeight; updateStats('chat',1); }

/* ---------- Voice recognition (Chrome) ---------- */
let recognition;
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.continuous = false; recognition.interimResults = false;
  recognition.onstart = ()=> { window._orbState && window._orbState('listening'); document.getElementById('voiceBtn').innerText='ðŸŽ™ï¸'; };
  recognition.onend = ()=> { window._orbState && window._orbState('idle'); document.getElementById('voiceBtn').innerText='ðŸŽ¤'; };
  recognition.onresult = (e)=> { const t = e.results[0][0].transcript; chatInput.value = t; userSend(); };
}
document.getElementById('voiceBtn').addEventListener('click', ()=> { if(recognition) recognition.start(); else alert('Voice not supported here â€” use Chrome'); });

/* ---------- Profile & Vault ---------- */
function fillProfile(){
  const name = localStorage.getItem('es_user') || 'Guest'; document.getElementById('profileName').innerText='Name: '+name;
  const st = JSON.parse(localStorage.getItem('es_stats')||'{}');
  document.getElementById('profileIdeas').innerText = st.ideaCount||0; document.getElementById('profileChats').innerText = st.chatCount||0;
}
function renderVaultFull(){ renderVaultFull(); } // placeholder
document.getElementById('vaultClose').addEventListener('click', ()=> show('app'));
document.getElementById('aiClose').addEventListener('click', ()=> show('app'));
function renderVaultFull(){
  const arr = JSON.parse(localStorage.getItem('es_vault')||'[]');
  const box = document.getElementById('vaultFull'); if(!box) return; box.innerHTML=''; arr.forEach(it=>{ const el = document.createElement('div'); el.className='glass'; el.style.padding='10px'; el.innerHTML = `<strong>${it.title}</strong><div style="font-size:12px;color:var(--muted)">${new Date(it.time).toLocaleString()}</div><p style="opacity:.9">${it.desc}</p>`; box.appendChild(el); });
}

/* ---------- Small initialisation ---------- */
window.EchoState = { mode: 'Creator' };
document.querySelectorAll('.pmode').forEach(b=> b.addEventListener('click', ()=>{ window.EchoState.mode = b.dataset.mode; document.getElementById('modeSelected').innerText = b.dataset.mode; document.getElementById('chatModeDisplay').innerText = b.dataset.mode; }));

// initial stats
(function init(){
  const st = JSON.parse(localStorage.getItem('es_stats')||'{}');
  document.getElementById('ideaCount').innerText = st.ideaCount||0; document.getElementById('chatCount').innerText = st.chatCount||0;
  document.getElementById('userNameDisplay').innerText = localStorage.getItem('es_user')||'Guest';
  document.getElementById('userGreeting').innerText = `Welcome, ${ (localStorage.getItem('es_user')||'Guest').split(' ')[0] }`;
  loadVaultShort();
})();
function loadVaultShort(){ const arr = JSON.parse(localStorage.getItem('es_vault')||'[]'); const v = document.getElementById('vaultList'); if(!v) return; v.innerHTML=''; arr.slice(0,3).forEach(it=>{ const el=document.createElement('div'); el.className='glass'; el.style.padding='8px'; el.innerText=it.title; v.appendChild(el); }); }

/* ---------- Simple orb state setter for visuals (used by voice/ai) ---------- */
window._orbState = (s) => { /* placeholder for future shader states */ console.log('Orb state:', s); };

/* ---------- Convenience: make Enter on some pages behave ---------- */
document.getElementById('nameField').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('loginBtn').click(); });
document.getElementById('seedInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('growBtn').click(); });
document.getElementById('gardenSeed').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('gardenGrow').click(); });

/* ---------- Expose show for debugging ---------- */
window.showPage = show;
</script>
</body>
</html>
